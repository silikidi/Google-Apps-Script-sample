/*******************************************************************************************************************
* Inline Bot Telegram Dengan DuckDuckGo Instant Answer
* 
* Salin ke file Code.gs atau file .gs tersendiri di Apps Script
********************************************************************************************************************/
const telegramAPIToken = "API_TOKEN_BOT_ANDA";
const telegramAPIURL = "https://api.telegram.org/bot" + telegramAPIToken;
const telegramAdminID = "ID_USER_ADMIN";
const telegramBotID = "ID_BOT";
const telegramBotUsername = "USERNAME_BOT_ANDA";
const googleWebAppsURL = "URL_WEB_APPS_ANDA";


/***********************************
* DEFAULT QUERY BILA TANPA KEYWORD *
************************************/
const queryDefault = [
  {
    type: "article",
    id: String(genID()),
    title: "INFOBOT",
    message_text: "@simrsinfobot" + "\n" + "Bot informasi ID dan Base64 generator" + "\n" + "crafted by SiLiKiDi",
    parse_mode: "HTML",
    disable_web_page_preview: false,
    url: "https://t.me/simrsinfobot",
    hide_url: true,
    description: "Bot informasi ID dan Base64 generator",
    thumb_url: "https://res.cloudinary.com/rsudcibabat/image/upload/v1629736555/assets/bot/boticon.jpg",
    thumb_width: 64,
    thumb_height: 64
  },
  {
    type: "article",
    id: String(genID()),
    title: "BOT JSON RESPONSE",
    message_text: "@simrsjsonbot" + "\n" + "Bot JSON Generator" + "\n" + "crafted by SiLiKiDi",
    parse_mode: "HTML",
    disable_web_page_preview: false,
    url: "https://t.me/simrsjsonbot",
    hide_url: true,
    description: "Bot JSON Generator",
    thumb_url: "https://res.cloudinary.com/rsudcibabat/image/upload/v1629736555/assets/bot/boticon.jpg",
    thumb_width: 64,
    thumb_height: 64
  },
  {
    type: "article",
    id: String(genID()),
    title: "TELEGRAM BOT SCRIPT",
    message_text: "<a href='https://telegram-bot-script.blogspot.com/'>TELEGRAM BOT SCRIPT</a>" + "\n" + "Tutorial Bot Telegram dengan Apps Script",
    parse_mode: "HTML",
    disable_web_page_preview: false,
    url: "https://telegram-bot-script.blogspot.com/",
    hide_url: true,
    description: "Step-by-step pemrograman interaksi Bot Telegram dengan Google Apps Script",
    thumb_url: "https://blogger.googleusercontent.com/img/a/AVvXsEhwCpCaBKv_dETin9reb18ZpjigkVtmvlqWlBGK1p1ZeuHqNx9CIV436lC5GlVJ503gbocG5LYA0BUWoEEdVi4oNa63Pl-XhUYGon8zJ636ojZlrLA7wHdHQ-kQHvwLH14WdNF55UV5XPnta2GQ02iGpRXadLbTINGnrzUSk5YfDkPa6gZ2x96CQtnO4Q=s0",
    thumb_width: 64,
    thumb_height: 64
  }
];


/***************************************************************
* getMe() untuk request info tentang bot *
* setWebHook() untuk membangun push system realtime dengan bot *
* deleteWebhook() menghapus koneksi yang dibangun setWebhook *
****************************************************************/
function getMe() {
  let url = telegramAPIURL + "/getMe";
  let response = UrlFetchApp.fetch( url );
  Logger.log( response.getContentText() );
}
function setWebhook() {
  let url = telegramAPIURL + "/setWebhook?url=" + googleWebAppsURL;
  let response = UrlFetchApp.fetch( url );
  Logger.log( response.getContentText() );
}
function deleteWebhook() {
  let url = telegramAPIURL + "/deleteWebhook";
  let response = UrlFetchApp.fetch( url );
  Logger.log( response.getContentText() );
}


/*********************
* FUNGSI KIRIM PESAN *
**********************/
function kirimPesan( chatID, pesan, menuTombol ) {
  let dataPesan = {
    method: "post",
    payload: {
      method: "sendMessage",
      parse_mode: "HTML",
      disable_web_page_preview: "false",
      chat_id: String( chatID ),
      text: pesan,
      reply_markup: menuTombol
    }
  };
  UrlFetchApp.fetch( telegramAPIURL + "/", dataPesan );   
}


/********************************************************************
* RANDOM ID GENERATOR *
* https://www.udacity.com/blog/2021/04/javascript-random-numbers.html
*********************************************************************/
function genID(){
  let minimal = 100000;
  let maksimal = 500000;
  return Math.floor(Math.random() * (maksimal - minimal + 1)) + minimal;
}


/*****************************
* FUNGSI ANSWER INLINE QUERY *
******************************/
function answerInlineQuery( queryID, queryResult ) {
  let dataQuery = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify({
      method: "answerInlineQuery",
      inline_query_id: String( queryID ),
      results: queryResult
    })
  };
  UrlFetchApp.fetch( telegramAPIURL + "/", dataQuery );
}


/************************************************************
* FUNGSI PENCARIAN DUCKDUCKGO INSTANT ANSWER API *
* Dokumentasi:
* https://api.duckduckgo.com/
* Contoh respon JSON:
* https://api.duckduckgo.com/?q=John+Doe&format=json&pretty=1
*************************************************************/
function searchDuckDuckGo( searchKeywords ) {

  let searchResult = [];
  
  if ( searchKeywords.trim() !== "" ){
    
    let searchURL = 'https://api.duckduckgo.com/?q=' + searchKeywords.trim().replace(' ', '+') + '&format=json';
    let dataJSON = JSON.parse( UrlFetchApp.fetch( searchURL ) );
    let data = dataJSON.RelatedTopics;
    
    if ( data.length > 0 ) {

      let regex = /(?<=<a[^>]*>)(.*?)(?=<\/a>)/g;

      for ( let i = 0; i < data.length; i++ ) {

        if ( (data[i] || {} ).Result ) {

          let searchObject = {};
          let dataTitle = data[i].Result.match( regex ).shift();
          let dataThumbURL = data[i].Icon.URL !== "" ? "https://duckduckgo.com" + data[i].Icon.URL : "";
          let dataMessageText = 
            "<a href='" + data[i].FirstURL+ "'>" + "<b>" + dataTitle + "</b>" + "</a>" + "\n" + "\n" 
            + data[i].Text + "\n" + "\n" 
            + data[i].FirstURL
            ;

          searchObject["type"] = "article";
          searchObject["id"] = String( genID() );
          searchObject["title"] = dataTitle;
          searchObject["message_text"] = dataMessageText;
          searchObject["description"] = data[i].Text;
          searchObject["url"] = data[i].FirstURL;
          searchObject["hide_url"] = true;
          searchObject["thumb_url"] = dataThumbURL;
          searchObject["parse_mode"] = "HTML";
          searchObject["disable_web_page_preview"] = false;

          searchResult.push( searchObject );


        } else if ( ( data[i] || {} ).Name === 'See also' ) {

          for ( let j = 0; j < data[i].Topics.length; j++ ) {

            let searchObject = {};
            let dataTitle = data[i].Topics[j].Result.match( regex ).shift();
            let dataThumbURL = data[i].Topics[j].Icon.URL !== "" ? "https://duckduckgo.com" + data[i].Topics[j].Icon.URL : "";
            let dataMessageText = 
              "<a href='" + data[i].Topics[j].FirstURL+ "'>" + "<b>" + dataTitle + "</b>" + "</a>" + "\n" + "\n" 
              + data[i].Topics[j].Text + "\n" + "\n" 
              + data[i].Topics[j].FirstURL
              ;

            searchObject["type"] = "article";
            searchObject["id"] = String( genID() );
            searchObject["title"] = dataTitle;
            searchObject["message_text"] = dataMessageText;
            searchObject["description"] = data[i].Topics[j].Text;
            searchObject["url"] = data[i].Topics[j].FirstURL;
            searchObject["hide_url"] = true;
            searchObject["thumb_url"] = dataThumbURL;
            searchObject["parse_mode"] = "HTML";
            searchObject["disable_web_page_preview"] = false;

            searchResult.push( searchObject );

          }
        }
      }
    }
  }
  return searchResult;
}


/*************************************************************
* FUNGSI PENERIMA KIRIMAN DATA DARI TELEGRAM API VIA WEBHOOK *
**************************************************************/
function doPost(e) {

  const data = JSON.parse( e.postData.contents );

  try {

    /************************
    * CEK BILA INLINE QUERY *
    *************************/
    if ( ( data || {} ).inline_query ) {

      let querySearch = data.inline_query.query;
      let queryID = data.inline_query.id;
      
      /********************************************************
      * BILA INGIN MENAMPILKAN STRUKTUR JSON *
      * kirimPesan( queryID, JSON.stringify( data, null, 4 ) );
      *********************************************************/
      
      /****************************
      * Bila ada keyword di query *
      *****************************/
      if ( querySearch.trim() !== "" ){
        
        let queryResult = searchDuckDuckGo( querySearch );
        if ( queryResult.length > 0 ) answerInlineQuery( queryID, queryResult );

      /******************************************
      * DEFAULT bila tidak ada keyword di query *
      *******************************************/
      } else answerInlineQuery( queryID, queryDefault );


    }
  } catch(e) { kirimPesan( telegramAdminID, e ); }
}
